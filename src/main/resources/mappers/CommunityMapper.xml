<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pingo.mapper.CommunityMapper">

    <!-- 정렬 기준에 따라 장소 리뷰 조회 -->
    <select id="selectPlaceReviewWithSort" parameterType="map" resultType="com.pingo.dto.community.PlaceReviewDTO">
        SELECT * FROM
        (
            SELECT PR.*, UR."userNick", UI."imageUrl" FROM "placeReview" PR
            JOIN "users" UR
            ON PR."userNo" = UR."userNo"
            JOIN "userImage" UI
            ON PR."userNo" = UI."userNo"
            WHERE PR."category" = #{cateSort}
            AND UI."imageProfile" = 'T'
            <trim prefix="ORDER BY" prefixOverrides=",">
                <if test="searchSort.equals('popular')">
                    PR."heart" DESC
                </if>
                <if test="searchSort.equals('newest')">
                    PR."regDate" ASC
                </if>
                <if test="searchSort == null or searchSort == ''">
                    PR."heart" DESC  <!-- 기본 정렬 -->
                </if>
            </trim>
        )
        WHERE ROWNUM &lt;= 10
    </select>

    <!-- 검색어로 장소 리뷰 조회 -->
    <select id="selectPlaceReviewWithKeyword" parameterType="map" resultType="com.pingo.dto.community.PlaceReviewDTO">
        SELECT PR.*, UR."userNick", UI."imageUrl" FROM "placeReview" PR
        JOIN "users" UR
        ON PR."userNo" = UR."userNo"
        JOIN "userImage" UI
        ON PR."userNo" = UI."userNo"
        WHERE PR."addressName" = #{keyword}
        AND UI."imageProfile" = 'T'
    </select>

    <!-- 장소 리뷰 삽입 -->
    <insert id="insertPlaceReview" parameterType="com.pingo.entity.community.PlaceReview">
        INSERT INTO "placeReview" ("prNo", "placeName", "thumb", "addressName", "roadAddressName", "userNo", "contents", "category", "latitude", "longitude", "heart")
        VALUES (#{prNo}, #{placeName}, #{thumb}, #{addressName}, #{roadAddressName}, #{userNo}, #{contents}, #{category}, #{latitude}, #{longitude}, #{heart})
    </insert>

    <!-- DatingGuide 최초 조회 -->
    <select id="selectDatingGuideForInit" resultType="com.pingo.dto.community.DatingGuideDTO">
        WITH RankedDatingGuide AS (
            SELECT "dgNo", "title", "contents", "thumb", "userNo", "heart", "regDate", "category",
            ROW_NUMBER() OVER (PARTITION BY "category" ORDER BY "heart" DESC) AS rank
            FROM "datingGuide"
        )
        SELECT RDG."dgNo", RDG."title", RDG."contents", RDG."thumb", RDG."userNo",
        RDG."heart", RDG."regDate", DGC."cateName", US."userName", UI."imageUrl"
        FROM RankedDatingGuide RDG
        JOIN "users" US ON RDG."userNo" = US."userNo"
        JOIN "userImage" UI ON RDG."userNo" = UI."userNo"
        JOIN "datingGuideCate" DGC ON RDG."category" = DGC."cateId"
        WHERE RDG.rank &lt;= 5
        AND UI."imageProfile" = 'T'
        ORDER BY RDG."category", RDG."heart" DESC
    </select>

    <!-- 개별 DatingGuide 정렬로 조회 -->
    <select id="selectDatingGuideWithSort" parameterType="map" resultType="com.pingo.dto.community.DatingGuideDTO">
        SELECT * FROM
        (
            SELECT DG."dgNo", DG."title", DG."contents", DG."thumb", DG."userNo",
            DG."heart", DG."regDate", US."userName", UI."imageUrl"
            FROM "datingGuide" DG
            JOIN "users" US
            ON DG."userNo" = US."userNo"
            JOIN "userImage" UI
            ON US."userNo" = UI."userNo"
            WHERE DG."category" = #{cate}
            AND UI."imageProfile" = 'T'
            <trim prefix="ORDER BY" prefixOverrides=",">
                <if test="sort.equals('popular')">
                    DG."heart" DESC
                </if>
                <if test="sort.equals('newest')">
                    DG."regDate" ASC
                </if>
                <if test="sort == null or sort == ''">
                    DG."heart" DESC
                </if>
            </trim>
        )
        WHERE ROWNUM &lt;= 5
    </select>
</mapper>
